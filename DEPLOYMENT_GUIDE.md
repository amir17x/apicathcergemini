# راهنمای استقرار برنامه در Railway

این راهنما به شما کمک می‌کند تا برنامه ربات تلگرام خود را به درستی در Railway استقرار دهید و مشکل `ModuleNotFoundError: No module named 'distutils'` را برطرف کنید.

## مشکل چیست؟

در Python 3.12 که در Railway استفاده می‌شود، ماژول `distutils` به صورت پیش‌فرض گنجانده نشده است. کتابخانه `undetected-chromedriver` که برای اتوماسیون وب استفاده می‌شود، به این ماژول وابسته است و بدون آن با خطا مواجه می‌شود.

## راه‌حل‌ها

برای رفع این مشکل، چندین راه‌حل در اختیار شما قرار داده شده است. می‌توانید یکی از این روش‌ها را انتخاب کنید:

### روش ۱: استفاده از Dockerfile (توصیه شده)

فایل `Dockerfile` که در مخزن ارائه شده، یک محیط پایدار با Python 3.10 و تمام وابستگی‌های مورد نیاز ایجاد می‌کند. کافی است اطمینان حاصل کنید که Railway برای استقرار از Dockerfile استفاده می‌کند.

1. در تنظیمات پروژه Railway، به بخش Settings بروید
2. در قسمت Deploy، حالت را به "Nixpacks" یا "Docker" تغییر دهید
3. فایل `Dockerfile` باید به صورت خودکار شناسایی و استفاده شود

### روش ۲: استفاده از تنظیمات Railway

فایل `railway.toml` تنظیمات لازم برای نصب وابستگی‌های سیستمی و استفاده از Python 3.10 را فراهم می‌کند.

### روش ۳: استفاده از Procfile و اسکریپت تعمیر

فایل `Procfile` و اسکریپت `fix-distutils.py` به طور خودکار مشکل را قبل از اجرای اصلی برنامه برطرف می‌کنند.

### روش ۴: تغییر دستی فایل patcher.py

می‌توانید فایل `patcher.py` را مستقیماً در محیط Railway بعد از استقرار تغییر دهید:

1. به ترمینال SSH در Railway وصل شوید
2. مسیر کتابخانه را پیدا کنید:
   ```bash
   find /opt -name patcher.py | grep undetected_chromedriver
   ```
3. فایل را ویرایش کنید:
   ```bash
   nano [مسیر_فایل_پیدا_شده]
   ```
4. خط `from distutils.version import LooseVersion` را به `from packaging.version import parse as LooseVersion` تغییر دهید
5. ابتدا مطمئن شوید که `pip install packaging` را اجرا کرده‌اید

## نکات مهم

1. **متغیرهای محیطی**: مطمئن شوید که تمام متغیرهای محیطی لازم (TELEGRAM_BOT_TOKEN، TWILIO_ACCOUNT_SID و غیره) در تنظیمات Railway وارد شده‌اند.

2. **پورت**: Railway به صورت خودکار یک پورت را از طریق متغیر محیطی `PORT` اختصاص می‌دهد. در Dockerfile و Procfile، از `${PORT:-5000}` استفاده شده تا در صورت عدم تعریف متغیر، از پورت 5000 استفاده شود. اگر با خطای `'$PORT' is not a valid port number` مواجه شدید، حتماً از این روش استفاده کنید.

3. **دیتابیس**: اگر از پایگاه داده PostgreSQL استفاده می‌کنید، مطمئن شوید که یک خدمت دیتابیس در Railway تنظیم کرده‌اید و متغیر محیطی `DATABASE_URL` به درستی تنظیم شده است.

4. **بازبینی لاگ‌ها**: بعد از استقرار، لاگ‌ها را بررسی کنید تا از اجرای صحیح برنامه مطمئن شوید.

## عیب‌یابی

اگر همچنان با مشکل مواجه هستید:

1. **خطای PORT**: اگر با خطای `'$PORT' is not a valid port number` مواجه می‌شوید، مراحل زیر را انجام دهید:
   - در `Dockerfile` و `Procfile` از عبارت `${PORT:-5000}` به جای `$PORT` استفاده کنید
   - در تنظیمات پروژه Railway متغیر محیطی `PORT` را به صورت دستی با مقدار عددی (مثلاً ۵۰۰۰) تنظیم کنید
   - در فایل `railway.toml` در بخش `[variables]` مقدار `PORT = "5000"` را اضافه کنید
   - برای هر متغیر محیطی در `${VAR}` اطمینان حاصل کنید که یک مقدار پیش‌فرض مانند `${VAR:-default}` در نظر گرفته شده

2. **مشکل healthcheck**: اگر healthcheck با خطا مواجه می‌شود:
   - مسیر healthcheck را از `/` به `/status` تغییر دهید (این مسیر JSON برمی‌گرداند و پایداری بیشتری دارد)
   - `healthcheckTimeout` را به عدد کوچکتری مانند ۱۲۰ کاهش دهید
   - ریستارت‌ها را با تنظیم `restartPolicyMaxRetries` به ۵ محدود کنید

3. **استفاده از نسخه خاص کتابخانه**: می‌توانید به صورت دستی نسخه خاصی از undetected-chromedriver را نصب کنید که با Python 3.12 سازگار است.

4. **غیرفعال کردن موقت**: برای تست، می‌توانید با تغییر موقت کد، بخش‌های مربوط به جیمیل‌کریتور و اتوماسیون وب را غیرفعال کنید تا حداقل ربات تلگرام کار کند.

5. **پشتیبانی Railway**: می‌توانید از تیم پشتیبانی Railway درخواست کمک کنید یا به انجمن آن‌ها مراجعه کنید.

امیدوارم یکی از این راه‌حل‌ها مشکل شما را برطرف کند!